<html lang="ko" layout:decorate="~{admin/layout/base}" xmlns:layout="http://www.w3.org/1999/xhtml">

<div layout:fragment="category" class="container-fluid">
    <div class="row">
        <h1>카테고리 관리</h1>
        <hr>

        <!-- 버튼 영역 -->
        <div class="col-12 p-3 d-flex justify-content-end">
            <button type="button" class="btn btn-primary me-1" id="btn-create-category">추가</button>
            <button type="button" class="btn btn-success me-1" id="btn-update-category">수정</button>
            <button type="button" class="btn btn-danger" id="btn-delete-category">삭제</button>
        </div>

        <!-- 대분류 영역 -->
        <div class="col-12 bg-light p-3 mb-3" id="toplevel-category-box">
            <div class="d-flex align-items-center justify-content-between">
                <h4>대분류</h4>
            </div>
            <div class="card mt-3">
                <div id="topLevelCategories" class="card-body">
                    <span th:each="topLevelCategory : ${topLevelCategories}"
                          th:text="${topLevelCategory.name}"
                          th:data-top-category-no="${topLevelCategory.no}"
                          class="border p-1 me-1"
                          id="topLevelCategory-${topLevelCategory.no}">
                    </span>
                </div>
            </div>
        </div>

        <!-- 중분류 영역 -->
        <div class="col-12 bg-light p-3 mb-3">
            <h4>중분류</h4>
            <div class="card mt-3">
                <div id="secondLevelCategories" class="card-body">
                    <!-- 중분류 내용 추가 -->
                </div>
            </div>
        </div>

        <!-- 소분류 영역 -->
        <div class="col-12 bg-light p-3">
            <h4>소분류</h4>
            <div class="card mt-3">
                <div id="thirdLevelCategories" class="card-body">
                    <!-- 소분류 내용 추가 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 카테고리 추가 모달창 -->
    <div class="modal fade" id="create-modal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">카테고리 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- 탭 구성 -->
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#top"
                                    type="button" role="tab" aria-controls="home" aria-selected="true">대분류
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#second"
                                    type="button" role="tab" aria-controls="profile" aria-selected="false">중분류
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#third"
                                    type="button" role="tab" aria-controls="contact" aria-selected="false">소분류
                            </button>
                        </li>
                    </ul>

                    <!-- 탭에 대한 컨텐츠 -->
                    <div class="tab-content pt-3" id="myTabContent">

                        <!-- 대분류 추가-->
                        <div class="tab-pane fade show active" id="top" role="tabpanel" aria-labelledby="home-tab">
                            <form>
                                <div class="form-group mb-3">
                                    <label for="top-input-top-category">대분류:</label>
                                    <input type="text" id="top-input-top-category" name="category">
                                </div>
                            </form>
                        </div>

                        <!-- 중분류 추가 -->
                        <div class="tab-pane fade" id="second" role="tabpanel" aria-labelledby="profile-tab">
                            <form>
                                <div class="form-group mb-3">
                                    <label for="second-select-top-category">대분류:</label>
                                    <select id="second-select-top-category" name="topLevelCategory">
                                        <option disabled selected>대분류 선택</option>
                                        <option th:each="topLevelCategory : ${topLevelCategories}"
                                                th:value="${topLevelCategory.no}"
                                                th:text="${topLevelCategory.name}">
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="second-input-second-category">중분류:</label>
                                    <input type="text" id="second-input-second-category" name="category">
                                </div>
                            </form>
                        </div>

                        <!-- 소분류 추가 -->
                        <div class="tab-pane fade" id="third" role="tabpanel" aria-labelledby="contact-tab">
                            <form>
                                <div class="form-group mb-3">
                                    <label for="third-select-top-category">대분류:</label>
                                    <select id="third-select-top-category">
                                        <option disabled selected>대분류 선택</option>
                                        <option th:each="topLevelCategory : ${topLevelCategories}"
                                                th:value="${topLevelCategory.no}"
                                                th:text="${topLevelCategory.name}">
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="third-select-second-category">중분류:</label>
                                    <select id="third-select-second-category">
                                        <option disabled selected>중분류 선택</option>
                                        <option th:each="secondLevelCategory : ${secondLevelCategories}"
                                                th:value="${secondLevelCategory.no}"
                                                th:text="${secondLevelCategory.name}">
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="third-input-third-category">소분류:</label>
                                    <input type="text" id="third-input-third-category" name="category">
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-close-create-modal">
                        닫기
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-add-create-modal">추가</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script layout:fragment="script" type="text/javascript">
    $(function () {

        // 추가 버튼 클릭 시 모달창 열기
        $("#btn-create-category").click(function () {
            let categoryFormModal = new bootstrap.Modal($("#create-modal"));
            categoryFormModal.show();
        });

        // 모달창 닫을 때 입력 내용 초기화
        $('#create-modal').on('hidden.bs.modal', function () {
            // 대분류 탭의 입력 요소 초기화
            $("#top-input-top-category").val("");

            // 중분류 탭의 입력 요소 초기화
            $("#second-select-top-category option").prop('selected', false).first().prop("selected", true);
            $("#second-input-second-category").val("");

            // 소분류 탭의 입력 요소 초기화
            $("#third-select-top-category option").prop('selected', false).first().prop("selected", true);
            initSecondCategories();
            $("#third-input-third-category").val("");

            /*
            // 모달 창 내의 모든 폼 요소를 선택합니다.
            var forms = $(this).find('form');

            // 각 폼 요소를 초기화합니다.
            forms.each(function () {
                // 폼 요소를 기본값으로 재설정합니다.
                this.reset();
            });
            */

            // 탭을 첫 번째 탭으로 리셋합니다.
            $(this).find('.nav-link').removeClass('active');
            $(this).find('.nav-link:first').addClass('active');
            $(this).find('.tab-pane').removeClass('show active');
            $(this).find('.tab-pane:first').addClass('show active');
        });

        // 중분류 select 요소 초기화
        function initSecondCategories() {
            $.ajax({
                url: "/admin/getSecondCategories",
                method: "GET",
                success: function (secondLevelCategories) {
                    var $secondCategorySelect = $('#third-select-second-category');

                    $secondCategorySelect.empty();
                    $secondCategorySelect.append('<option disabled selected>중분류 선택</option>');

                    secondLevelCategories.forEach(secondLevelCategory => {
                        var option = $('<option>')
                            .val(secondLevelCategory.no)
                            .text(secondLevelCategory.name);

                        $secondCategorySelect.append(option);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("소분류 데이터 요청 실패:", error);
                }
            });
        }

        // 대분류 카테고리 클릭 시 관련된 중분류 카테고리 표시
        $("span[id^=topLevelCategory]").click(function () {
            const categoryNo = $(this).data("topCategoryNo");

            $("#thirdLevelCategories").empty();
            showSecondCategoriesByTopCategoryNo(categoryNo);
        });

        // 카테고리 클릭시 강조 표시
        $("div[id$=Categories].card-body").on("click", "span", function () {
            $(this).addClass("bg-primary-subtle").siblings().removeClass("bg-primary-subtle");
        });

        // 대분류 카테고리 번호와 관련된 증분류 카테고리 span 요소로 표시
        function showSecondCategoriesByTopCategoryNo(categoryNo) {
            $.ajax({
                url: "/admin/getSubCategories",
                method: "GET",
                data: {category: categoryNo},
                success: function (secondLevelCategories) {
                    const $secondLevelCategories = $("#secondLevelCategories");

                    $secondLevelCategories.empty();

                    secondLevelCategories.forEach(secondLevelCategory => {
                        const $span = $("<span>")
                            .addClass("border p-1 me-1")
                            .text(secondLevelCategory.name)
                            .attr("data-second-category-no", secondLevelCategory.no)
                            .attr("id", `secondLevelCategory-${secondLevelCategory.no}`);

                        $secondLevelCategories.append($span);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("중분류 데이터 요청 실패:", error);
                }
            });
        }

        // 중분류 카테고리 클릭 시 관련된 소분류 카테고리 표시
        $("#secondLevelCategories").on("click", "span[id^=secondLevelCategory]", function () {
            const categoryNo = $(this).data("secondCategoryNo");

            showThirdCategoriesBySecondCategoryNo(categoryNo);
        });

        // 중분류 카테고리 번호와 관련된 소분류 카테고리 span 요소로 표시
        function showThirdCategoriesBySecondCategoryNo(categoryNo) {
            $.ajax({
                url: "/admin/getSubCategories",
                method: "GET",
                data: {category: categoryNo},
                success: function (thirdLevelCategories) {
                    const $thirdLevelCategories = $("#thirdLevelCategories");

                    $thirdLevelCategories.empty();

                    thirdLevelCategories.forEach(thirdLevelCategory => {
                        const $span = $("<span>")
                            .addClass("border p-1 me-1")
                            .text(thirdLevelCategory.name)
                            .attr("data-third-category-no", thirdLevelCategory.no)
                            .attr("id", `thirdLevelCategory-${thirdLevelCategory.no}`);

                        $thirdLevelCategories.append($span);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("소분류 데이터 요청 실패:", error);
                }
            });
        }

        // 모달창의 소분류 탭에서 대분류 카테고리 선택 시 관련된 중분류 카테고리 표시
        $('#third-select-top-category').change(function () {
            const categoryNo = $(this).val();
            updateSecondCategoriesOptions(categoryNo);
        });

        // 대분류 카테고리 번호와 관련된 중분류 카테고리 option 요소로 표시
        function updateSecondCategoriesOptions(categoryNo) {
            $.ajax({
                url: "/admin/getSubCategories",
                method: "GET",
                data: {category: categoryNo},
                success: function (secondLevelCategories) {
                    var $secondCategorySelect = $('#third-select-second-category option');
                    $secondCategorySelect.not(':first').remove();
                    $secondCategorySelect.first().prop("selected", true);

                    secondLevelCategories.forEach(secondLevelCategory => {
                        var option = $('<option>')
                            .val(secondLevelCategory.no)
                            .text(secondLevelCategory.name);

                        $secondCategorySelect.parent().append(option);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("소분류 데이터 요청 실패:", error);
                }
            });
        }

        // 모달창의 소분류 탭에서 중분류 카테고리 선택 시 일치하는 대분류 카테고리 선택
        $('#third-select-second-category').change(function () {
            const categoryNo = $(this).val();
            selectTopCategory(categoryNo);
        });

        // 중분류 카테고리 번호와 관련된 대분류 카테고리 선택
        function selectTopCategory(categoryNo) {
            $.ajax({
                url: "/admin/getParentCategory",
                method: "GET",
                data: {category: categoryNo},
                success: function (topLevelCategory) {
                    $('#third-select-top-category option').each(function () {
                        var option = $(this);
                        if (option.val() === topLevelCategory.no) {
                            option.attr('selected', true);
                        } else {
                            option.attr('selected', false);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("소분류 데이터 요청 실패:", error);
                }
            });
        }

        // 분류별 카테고리 저장
        $("#btn-add-create-modal").click(function () {
            let tab = $(".nav-tabs .nav-link.active").text().trim();
            if (tab === '대분류') {
                createTopCategory();
            }
            if (tab === "중분류") {
                createSecondCategory();
            }
            if (tab === "소분류") {
                createThirdCategory();
            }
        });

        // 대분류 카테고리 생성
        function createTopCategory() {
            let categoryName = $("#top-input-top-category").val();

            $.ajax({
                url: "/admin/addTopCategory",
                method: "POST",
                data: {categoryName: categoryName},
                success: function (topLevelCategories) {
                    const $topCategorySpan = $("#topLevelCategories");

                    $topCategorySpan.empty();

                    topLevelCategories.forEach(topLevelCategory => {
                        const $span = $("<span>")
                            .addClass("border p-1 me-1")
                            .text(topLevelCategory.name)
                            .attr("data-top-category-no", topLevelCategory.no)
                            .attr("id", `topLevelCategory-${topLevelCategory.no}`);

                        $topCategorySpan.append($span);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("에러발생:", error);
                }
            });
        }

        // 중분류 카테고리 생성
        function createSecondCategory() {
            let categoryName = $("#second-input-second-category").val();
            let topCategoryNo = $("#second-select-top-category").val();

            $.ajax({
                url: "/admin/addSubCategory",
                method: "POST",
                data: {categoryName: categoryName, CategoryNo: topCategoryNo},
                success: function (secondLevelCategories) {
                    const $secondLevelCategories = $("#secondLevelCategories");

                    $secondLevelCategories.empty();

                    secondLevelCategories.forEach(secondLevelCategory => {
                        const $span = $("<span>")
                            .addClass("border p-1 me-1")
                            .text(secondLevelCategory.name)
                            .attr("data-second-category-no", secondLevelCategory.no)
                            .attr("id", `secondLevelCategory-${secondLevelCategory.no}`);

                        $secondLevelCategories.append($span);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("에러발생:", error);
                }
            });
        }

        // 소분류 카테고리 생성
        function createThirdCategory() {
            let categoryName = $("#third-input-third-category").val();
            let secondCategoryNo = $("#third-select-second-category").val();

            $.ajax({
                url: "/admin/addSubCategory",
                method: "POST",
                data: {categoryName: categoryName, CategoryNo: secondCategoryNo},
                success: function (thirdLevelCategories) {
                    const $thirdLevelCategories = $("#thirdLevelCategories");

                    $thirdLevelCategories.empty();

                    thirdLevelCategories.forEach(thirdLevelCategory => {
                        const $span = $("<span>")
                            .addClass("border p-1 me-1")
                            .text(thirdLevelCategory.name)
                            .attr("data-third-category-no", thirdLevelCategory.no)
                            .attr("id", `thirdLevelCategory-${thirdLevelCategory.no}`);

                        $thirdLevelCategories.append($span);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("에러발생:", error);
                }
            });
        }

    })
</script>

</html>
