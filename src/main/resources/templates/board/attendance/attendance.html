<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://thymeleaf.org"
      layout:decorate="~{layout/base}" >

<div layout:fragment="content" class="container mt-5">
    <!-- 사용자 정보와 출석체크 상태 표시 -->
    <div class="row">
        <div class="col text-end">
            <h1 class="text-center">출석체크</h1>
            <p style="margin-bottom: 10px;">이름: <span th:text="${user.name}"></span></p>
            <!-- 출석체크 상태 표시 -->
            <div th:if="${attendance != null}" style="margin-bottom: 10px;">
                <p style="margin-bottom: 5px;" id="lastAttendanceDate">마지막 출석일: <span th:text="${#temporals.format(attendance.checkDate, 'yyyy.MM.dd')}"></span></p>
                <p th:if="${isUserAlreadyAttendance}">이벤트 대상자</p>
            </div>
        </div>
    </div>
    <!-- 출석체크 이벤트 참여하기 버튼 -->
    <div class="row">
        <div class="col text-end">
            <form method="post" th:action="@{/board/attendance/register}">
                <input type="hidden" name="userNo" th:value="${user.no}">
                <button class="btn btn-primary" th:if="${attendance == null}" th:disabled="${isUserAlreadyAttendance}">
                    출석체크 이벤트 참여하기
                </button>
            </form>
        </div>
    </div>

    <div class="table-responsive"> <!-- 반응형 디자인을 적용하여 작은 화면에서도 스크롤 가능하도록 함 -->
        <table class="table table-bordered table-striped" style="background-color: white; color: black;"> <!-- 테이블의 높이를 1.5배로 늘림 -->
            <thead style="background-color: white; color: black;">
            <tr class="table-primary">
                <th style="text-align: center; width: 14.28%; height: 50px;">일</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">월</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">화</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">수</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">목</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">금</th>
                <th style="text-align: center; width: 14.28%; height: 50px;">토</th>
            </tr>
            </thead>
            <tbody id="calendar-body" style="background-color: white; color: black;">
            <!-- 여기에 날짜를 동적으로 채워 넣을 것입니다. -->
            </tbody>
        </table>
    </div>

    <div class="text-center">
        <form method="post" th:action="@{/board/attendance/update}">
            <input type="hidden" name="userNo" th:value="${user.no}">
            <button type="submit" class="btn btn-outline-primary" id="attendanceButton" onclick="handleAttendance()">출석체크하기</button>
        </form>
    </div>

    <script>
        // 페이지 로드 시 실행되는 함수
        document.addEventListener("DOMContentLoaded", function() {
            // 현재 달력의 날짜를 생성
            generateCalendar(getCurrentDate());

        });



        // 현재 날짜를 가져오는 함수
        function getCurrentDate() {
            return new Date();
        }

        // 월의 첫 날을 가져오는 함수
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        // 월의 마지막 날을 가져오는 함수
        function getLastDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        // 특정 월의 달력을 생성하는 함수
        function generateCalendar(date) {
            var tableBody = document.getElementById("calendar-body");
            var firstDay = getFirstDayOfMonth(date);
            var lastDay = getLastDayOfMonth(date);
            var currentDate = getCurrentDate();

            var row = "";
            var currentDay = 1;

            // 달의 첫째날이 무슨 요일인지 확인
            var firstDayOfWeek = firstDay.getDay();

            // 행 추가
            for (var i = 0; i < 6; i++) {
                row += "<tr>";

                // 열 추가
                for (var j = 0; j < 7; j++) {
                    if ((i === 0 && j < firstDayOfWeek) || currentDay > lastDay.getDate()) {
                        row += "<td style='height: 100px;'></td>"; // 비어 있는 셀
                    } else {
                        var isToday = firstDay.toDateString() === currentDate.toDateString();
                        row += "<td style='text-align: center; height: 100px; padding: 15px; vertical-align: middle;" + (isToday ? " background-color: #e9ecef;" : "") + "'>" + currentDay + "</td>";
                        currentDay++;
                    }
                }

                row += "</tr>";
            }

            tableBody.innerHTML = row;
        }

        // 출석 버튼 클릭 시 실행되는 함수
        function handleAttendance() {
            // 여기서는 간단히 경고창을 띄워 보여주는 예시
            alert("출석 처리되었습니다.");
            // 여기에 실제 출석 처리 로직을 구현할 수 있습니다.

            // 버튼 비활성화 함수 호출
            disableButton();

            // 출석 처리된 날짜의 텍스트를 "출석 완료"로 변경
            var currentDate = new Date();
            var currentDay = currentDate.getDate();

            // 현재 날짜에 해당하는 숫자의 글씨색을 파란색으로 변경
            var dayElements = document.querySelectorAll("#calendar-body td");
            for (var i = 0; i < dayElements.length; i++) {
                var dayElement = dayElements[i];
                if (parseInt(dayElement.innerText) === currentDay) {
                    dayElement.innerText = "출석 완료";
                    dayElement.style.fontWeight = "bold";
                    dayElement.style.color = "green";
                }
            }
        }

        // 버튼 비활성화 함수
        function disableButton() {
            // 출석 버튼 엘리먼트 가져오기
            var attendanceButton = document.getElementById("attendanceButton");

            // 다음날인 경우 버튼 활성화
            var currentDate = new Date();
            var lastAttendanceDateString = document.getElementById("lastAttendanceDate").innerText;
            var lastAttendanceDate = new Date(lastAttendanceDateString); // 마지막 출석 날짜를 Date 객체로 변환

            // 현재 날짜와 마지막 출석 날짜가 다음 날인지 확인
            var isNextDay = currentDate.getDate() !== lastAttendanceDate.getDate() ||
                currentDate.getMonth() !== lastAttendanceDate.getMonth() ||
                currentDate.getFullYear() !== lastAttendanceDate.getFullYear();
            // 다음 날인 경우 버튼 활성화
            if (isNextDay) {
                attendanceButton.disabled = false;
            } else {
                attendanceButton.disabled = true;
            }
        }

        // 페이지 로드 시 실행
        window.onload = function() {
            // 페이지 로드 시 버튼 비활성화 함수 호출
            disableButton();
        };


    </script>
</div>