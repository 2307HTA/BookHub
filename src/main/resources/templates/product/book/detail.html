<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"  xmlns:th="http://thymeleaf.org"
       layout:decorate="~{layout/base}" >

    <div layout:fragment="content" class="container my-3">
        <div class="row mb-3">
            <div class="col-3">
                <h3 id="book-no" th:text="${book.bookNo}" style="display:none">책 번호</h3>
                <h3 class="d-flex justify-content-center" th:text="${book.name}"><strong>책 제목</strong></h3>
                <h5 class="d-flex justify-content-center">책 설명</h5>

                <div id="carouselExample" class="carousel slide" style="width: 300px; height: 500px; margin: 0 auto;" >
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img src="" class="d-block w-100" alt="...">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <div class="col-9">
                <span class="badge rounded-pill text-bg-primary">베스트셀러</span>
                <span class="badge rounded-pill text-bg-secondary">10%</span>
                <div>
                    <span><strong>10%</strong></span>
                    <span th:text="${book.price}"><strong>13,500</strong>원</span>
                </div>
                <div>
                    <span><strong>적립/혜택</strong></span>
                    <span th:text="${book.price} * ${book.discountRate}"><strong>750</strong>P</span>
                </div>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#">이벤트</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">상품정보</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">리뷰()</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">교환/반품/품절</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- 바텀 네비게이션 바 -->
        <nav class="navbar fixed-bottom navbar-light bg-light">
            <form class="container-fluid justify-content-end">
                <button class="btn btn-outline-secondary me-3" type="button" onclick="toggleAct(this)"><i id="wish-list" class="bi bi-heart"></i></button>
                <button class="btn btn-outline-secondary me-3" type="button" onclick="createOrIncreaseCart()">장바구니</button>
                <button class="btn btn-outline-success me-3" type="button">선물하기</button>
                <button class="btn btn-outline-success me-3" type="button">바로 주문</button>
            </form>
        </nav>

        <!-- 모달 창 -->
        <div id="modal-move-to-cart" class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">상품이 장바구니에 담겼습니다.</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>장바구니로 이동하시겠습니까?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <a type="button" class="btn btn-primary" href="/product/cart">장바구니로 이동</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 모달 창 -->
        <div id="modal-increase-cart" class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">이미 장바구니에 존재하는 상품이라 수량이 추가되었습니다.</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>장바구니로 이동하시겠습니까?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <a type="button" class="btn btn-primary" href="/product/cart">장바구니로 이동</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script layout:fragment="script" type="text/javascript">

        const url = "http://localhost:8080/product/cart"
        let bookNo = parseInt($("#book-no").text());
        const modalMoveToCart = new bootstrap.Modal("#modal-move-to-cart");
        const modalIncreaseCart = new bootstrap.Modal("#modal-increase-cart");

        function showAlertModal(existOrNot){
            console.log(existOrNot);
            if(existOrNot === "exist"){
                modalIncreaseCart.show();
            }
            else{
                modalMoveToCart.show();
            }
        }

        async function createOrIncreaseCart(){
            let response = await fetch("/product/cart/create/" + bookNo);
            if(!response.ok){
                console.log("장바구니 추가 실패");
            }

            let jsonData = await response.json();

            await showAlertModal(jsonData.existOrNot);
        }

        async function toggleAct(button) {
            let heartIcon = button.querySelector('#wish-list');

            if (heartIcon.classList.contains('bi-heart-fill')) {
                heartIcon.classList.remove('bi-heart-fill');
                heartIcon.classList.add('bi-heart');

                let response = await fetch("/product/wishlist/delete/" + bookNo);
                if(!response.ok){
                    console.log("위시리스트 추가 실패");
                }
            } else if(heartIcon.classList.contains('bi-heart')) {
                heartIcon.classList.add('bi-heart-fill');
                heartIcon.classList.remove('bi-heart');

                let response = await fetch("/product/wishlist/create/" + bookNo);
                if(!response.ok){
                    console.log("위시리스트 추가 실패");
                }
            }
        }
    </script>
</html>