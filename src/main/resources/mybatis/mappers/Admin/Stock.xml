<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.bookhub.admin.mapper.StockMapper">

    <!-- 재사용 조건절 -->
    <sql id="where">
        <where>
            <!-- 검색어 -->
            <if test="filter.opt != null">
                <choose>
                    <when test="filter.opt == 'notificationNo'">
                        SN.NOTIFICATION_NO = #{filter.keyword}
                    </when>
                    <when test="filter.opt == 'bookNo'">
                        AND B.BOOK_NO = #{filter.keyword}
                    </when>
                    <when test="filter.opt == 'publisherName'">
                        AND P.PUBLISHER_NAME = #{filter.keyword}
                    </when>
                </choose>
            </if>

            <!-- 기간 검색 -->
            <if test="filter.moreDate != '' and filter.lessDate != ''">
                <choose>
                    <when test="filter.dateOpt == 'createdDate'">
                        AND SN.NOTIFICATION_CREATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                         AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                </choose>
            </if>

            <if test="filter.moreDate == '' and filter.lessDate != ''">
                <choose>
                    <when test="filter.dateOpt == 'createdDate'">
                        AND SN.NOTIFICATION_CREATED_DATE BETWEEN '0001-01-01 00:00:00'
                                                         AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                </choose>
            </if>

            <if test="filter.moreDate != '' and filter.lessDate == ''">
                <choose>
                    <when test="filter.dateOpt == 'createdDate'">
                        AND SN.NOTIFICATION_CREATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                         AND '9999-12-31 23:59:59'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="getTotalRows" resultType="int">
        SELECT
                count(*)
        FROM
                BookHub.STOCK_NOTIFICATION SN
                INNER JOIN BOOK B ON SN.BOOK_NO = B.BOOK_NO
                INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO
        <include refid="where"></include>
    </select>

    <select id="getStockNotifications" resultType="com.example.bookhub.admin.vo.Stock">
    		SELECT
                    SN.NOTIFICATION_NO                                  AS notificationNo,
    		        B.BOOK_NO			                                AS bookNo,
    				SN.NOTIFICATION_CREATED_DATE           			    AS createdDate,
                    SN.NOTIFICATION_COMPLETED_DATE			            AS completedDate,
                    SN.NOTIFICATION_COMPLETED_YN                        AS completedYn,
                    P.PUBLISHER_NAME                                    AS publisherName
    		FROM
                    BookHub.STOCK_NOTIFICATION SN
                    INNER JOIN BOOK B ON SN.BOOK_NO = B.BOOK_NO
                    INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO

            <include refid="where"></include>

            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="getPublishers" resultType="com.example.bookhub.product.vo.Publisher">
            SELECT
                PUBLISHER_NO AS no,
                PUBLISHER_NAME AS name
            FROM
                BookHub.PUBLISHER
            ORDER BY
                PUBLISHER_NAME ASC
    </select>

    <select id="getAuthors" resultType="com.example.bookhub.product.vo.Author">
            SELECT
                AUTHOR_NO AS no,
                AUTHOR_NAME AS name
            FROM
                BookHub.AUTHOR
            ORDER BY
                AUTHOR_NAME ASC
    </select>

    <update id="deleteProductByNo" parameterType="long">
        UPDATE BookHub.BOOK
        SET BOOK_DELETED_YN = 'Y',
            BOOK_STATUS = '삭제'
        WHERE BOOK_NO = #{deletedProductNo}
    </update>

    <select id="getProductByNo" parameterType="long" resultType="com.example.bookhub.admin.dto.Product">
        SELECT
                B.BOOK_NO                   AS no,
                B.CATEGORY_NO               AS secondCategoryNo,
                B.BOOK_NAME                 AS name,
                B.BOOK_DESCRIPTION          AS description,
                B.PUBLISHER_NO              AS publisherNo,
                B.BOOK_STATUS               AS status,
                B.BOOK_LIST_PRICE           AS listPrice,
                B.BOOK_DISCOUNT_RATE        AS discountRate,
                B.BOOK_STOCK                AS stock,
                BI.BOOK_IMAGE_COVER         AS coverImage,
                BI.BOOK_IMAGE_THUMBNAIL     AS thumbnailImage,
                BI.BOOK_IMAGE_DESCRIPTION   AS descriptionImage
        FROM
                BookHub.BOOK B
                INNER JOIN BOOK_IMAGES BI ON B.BOOK_NO = BI.BOOK_NO
        WHERE
                B.BOOK_NO = #{no}
    </select>

    <select id="getSuperCategoryNoBySubCategoryNo" parameterType="long" resultType="long">
        SELECT
                CATEGORY_NO
        FROM
                BookHub.CATEGORY
        WHERE
                CATEGORY_NO = (SELECT PARENT_CATEGORY_NO
                               FROM BookHub.CATEGORY
                               WHERE CATEGORY_NO = #{secondCategoryNo});
    </select>

    <update id="modifyProduct" parameterType="com.example.bookhub.admin.dto.Product">
        UPDATE
                BookHub.BOOK
        SET
                CATEGORY_NO = #{secondCategoryNo},
                BOOK_NAME = #{name},
                BOOK_DESCRIPTION = #{description},
                PUBLISHER_NO = #{publisherNo},
                BOOK_STATUS = #{status},
                BOOK_LIST_PRICE = #{listPrice},
                BOOK_DISCOUNT_RATE = #{discountRate},
                BOOK_STOCK = #{stock}
        WHERE
                BOOK_NO = #{no}
    </update>

    <insert id="registerProduct" parameterType="com.example.bookhub.admin.dto.Product">
        <selectKey resultType="long" keyProperty="no" order="BEFORE">
            SELECT max(BOOK_NO) + 1
            FROM BookHub.BOOK
        </selectKey>
        INSERT INTO BookHub.BOOK
        (BOOK_NO, BOOK_NAME, BOOK_PUBLISHED_DATE, BOOK_DESCRIPTION, ISBN, BOOK_LIST_PRICE, PUBLISHER_NO, CATEGORY_NO, BOOK_PAGES, BOOK_LANGUAGE, BOOK_WEIGHT, BOOK_INDEX, BOOK_TOTAL_NUMBER, BOOK_SIZE, BOOK_DISCOUNT_RATE, BOOK_STOCK, BOOK_STATUS)
        VALUES
        (#{no} , #{name}, #{publishedDate}, #{description}, #{isbn}, #{listPrice}, #{publisherNo}, #{categoryNo}, #{pages}, #{language}, #{weight}, #{index}, #{totalNumber}, #{size}, #{discountRate}, #{stock}, #{status})
    </insert>

    <insert id="registerImage" parameterType="com.example.bookhub.admin.dto.Product">
        <selectKey resultType="long" keyProperty="no" order="BEFORE">
            SELECT max(BOOK_NO)
            FROM BookHub.BOOK
        </selectKey>
        INSERT INTO BookHub.BOOK_IMAGES
        (BOOK_NO, BOOK_IMAGE_THUMBNAIL, BOOK_IMAGE_COVER, BOOK_IMAGE_DESCRIPTION)
        VALUES
        (#{no}, #{thumbnailImg}, #{coverImg}, #{descriptionImg})
    </insert>

</mapper>
