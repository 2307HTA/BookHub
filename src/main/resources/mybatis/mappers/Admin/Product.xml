<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.bookhub.admin.mapper.ProductMapper">

    <!-- 재사용 조건절 -->
    <sql id="where">
        <where>
            <!-- 검색어 -->
            <if test="filter.opt != null">
                <choose>
                    <when test="filter.opt == 'productName'">
                        B.BOOK_NAME LIKE CONCAT('%', #{filter.keyword}, '%')
                    </when>
                    <when test="filter.opt == 'authorName'">
                        AND B.BOOK_NO IN (SELECT BA.BOOK_NO
                                          FROM BOOK_AUTHOR BA
                                          INNER JOIN AUTHOR A ON BA.AUTHOR_NO = A.AUTHOR_NO
                                          WHERE A.AUTHOR_NAME =  #{filter.keyword})
                    </when>
                    <when test="filter.opt == 'publisherName'">
                        AND P.PUBLISHER_NAME = #{filter.keyword}
                    </when>
                </choose>
            </if>

            <!-- 카테고리 -->
            <choose>
                <when test="filter.topCategoryNo != 0">
                    AND B.CATEGORY_NO IN (SELECT CATEGORY_NO
                    FROM BookHub.CATEGORY
                    WHERE PARENT_CATEGORY_NO = #{filter.topCategoryNo})
                </when>
                <when test="filter.secondCategoryNo != 0">
                    AND B.CATEGORY_NO = #{filter.secondCategoryNo}
                </when>
            </choose>

            <!-- 기간 검색 -->
            <if test="filter.moreDate != '' and filter.lessDate != ''">
                <choose>
                    <when test="filter.period == 'createdDate'">
                        AND B.BOOK_CREATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                    <when test="filter.period == 'updatedDate'">
                        AND B.BOOK_UPDATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                    <when test="filter.period == 'publishedDate'">
                        AND B.BOOK_PUBLISHED_DATE BETWEEN #{filter.moreDate} AND #{filter.lessDate}
                    </when>
                </choose>
            </if>

            <if test="filter.moreDate == '' and filter.lessDate != ''">
                <choose>
                    <when test="filter.period == 'createdDate'">
                        AND B.BOOK_CREATED_DATE BETWEEN '0001-01-01 00:00:00'
                                                AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                    <when test="filter.period == 'updatedDate'">
                        AND B.BOOK_UPDATED_DATE BETWEEN '0001-01-01 00:00:00'
                                                AND CONCAT(#{filter.lessDate}, ' 23:59:59')
                    </when>
                    <when test="filter.period == 'publishedDate'">
                        AND B.BOOK_PUBLISHED_DATE BETWEEN '0001-01-01' AND #{filter.lessDate}
                    </when>
                </choose>
            </if>

            <if test="filter.moreDate != '' and filter.lessDate == ''">
                <choose>
                    <when test="filter.period == 'createdDate'">
                        AND B.BOOK_CREATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                AND '9999-12-31 23:59:59'
                    </when>
                    <when test="filter.period == 'updatedDate'">
                        AND B.BOOK_UPDATED_DATE BETWEEN CONCAT(#{filter.moreDate},' 00:00:00')
                                                AND '9999-12-31 23:59:59'
                    </when>
                    <when test="filter.period == 'publishedDate'">
                        AND B.BOOK_PUBLISHED_DATE BETWEEN #{filter.moreDate} AND '9999-12-31'
                    </when>
                </choose>
            </if>

            <!-- 판매 상태 -->
            <if test="filter.status != null">
                AND B.BOOK_STATUS IN
                    <foreach collection="filter.status" item="status" open="(" close=")" separator=",">
                        #{status}
                    </foreach>
            </if>

            <!-- 재고 -->
            <if test="filter.moreStock != 0">
                AND B.BOOK_STOCK >= #{filter.moreStock}
            </if>
            <if test="filter.lessStock != 0">
                AND B.BOOK_STOCK &lt;= #{filter.lessStock}
            </if>

            <!-- 출판사 -->
            <if test="filter.publisherNo != 0">
                AND P.PUBLISHER_NO = #{filter.publisherNo}
            </if>
        </where>
    </sql>

    <select id="getTotalRows" resultType="int">
        SELECT
            count(DISTINCT B.BOOK_NO)
        FROM
                BookHub.BOOK B
                INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO
                INNER JOIN BOOK_IMAGES BI ON B.BOOK_NO = BI.BOOK_NO
                INNER JOIN CATEGORY CA ON B.CATEGORY_NO = CA.CATEGORY_NO
        <include refid="where"></include>
    </select>

    <select id="getBooks" resultType="com.example.bookhub.admin.dto.BookList">
    		SELECT
                    B.BOOK_NO                                                   AS no,
    		        BI.BOOK_IMAGE_COVER			                                AS image,
    				B.BOOK_NAME           			                            AS bookName,
                    B.BOOK_LIST_PRICE			                                AS listPrice,
                    ROUND(B.BOOK_LIST_PRICE * (1 - B.BOOK_DISCOUNT_RATE))		AS sellingPrice,
                    B.BOOK_STOCK                                                AS stock,
                    B.BOOK_STATUS                                               AS status,
                    B.BOOK_CREATED_DATE                                         AS createdDate,
                    B.BOOK_UPDATED_DATE                                         AS updatedDate,
                    B.BOOK_PUBLISHED_DATE                                       AS publishedDate,
                    (SELECT GROUP_CONCAT(A.AUTHOR_NAME SEPARATOR ', ')
                    FROM BOOK_AUTHOR BA
                    INNER JOIN AUTHOR A ON BA.AUTHOR_NO = A.AUTHOR_NO
                    WHERE BA.BOOK_NO = B.BOOK_NO)                               AS authorName

    		FROM
                    BookHub.BOOK B
                    INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO
                    INNER JOIN BOOK_IMAGES BI ON B.BOOK_NO = BI.BOOK_NO
                    INNER JOIN CATEGORY CA ON B.CATEGORY_NO = CA.CATEGORY_NO

            <include refid="where"></include>

            <choose>
                    <when test="sort == 'productName'">
                        ORDER BY BOOK_NAME ASC
                    </when>
                    <when test="sort == 'highPrice'">
                        ORDER BY BOOK_LIST_PRICE DESC
                    </when>
                    <when test="sort == 'lowPrice'">
                        ORDER BY BOOK_LIST_PRICE ASC
                    </when>
                    <when test="sort == 'highSellingPrice'">
                        ORDER BY BOOK_SELLING_PRICE DESC
                    </when>
                    <when test="sort == 'lowSellingPrice'">
                        ORDER BY BOOK_SELLING_PRICE ASC
                    </when>
                    <when test="sort == 'highStock'">
                        ORDER BY BOOK_STOCK DESC
                    </when>
                    <when test="sort == 'lowStock'">
                        ORDER BY BOOK_STOCK ASC
                    </when>
                    <when test="sort == 'recentlyCreated'">
                        ORDER BY BOOK_CREATED_DATE DESC
                    </when>
                    <when test="sort == 'recentlyUpdated'">
                        ORDER BY BOOK_UPDATED_DATE DESC
                    </when>
                    <when test="sort == 'recentlyPublished'">
                        ORDER BY BOOK_PUBLISHED_DATE DESC
                    </when>
            </choose>

            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="getPublishers" resultType="com.example.bookhub.product.vo.Publisher">
            SELECT
                PUBLISHER_NO AS no,
                PUBLISHER_NAME AS name
            FROM
                BookHub.PUBLISHER
            ORDER BY
                PUBLISHER_NAME ASC
    </select>

    <update id="deleteProductByNo" parameterType="long">
        UPDATE BookHub.BOOK
        SET BOOK_DELETED_YN = 'Y'
        WHERE BOOK_NO = #{deletedProductNo}
    </update>
</mapper>
