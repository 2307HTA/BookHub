<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.bookhub.admin.mapper.ProductMapper">
    <select id="getTotalRows" resultType="int">
        SELECT
                count(*)
        FROM
                BookHub.BOOK B
                INNER JOIN BOOK_AUTHOR BA ON B.BOOK_NO = BA.BOOK_NO
                INNER JOIN AUTHOR A ON BA.AUTHOR_NO = A.AUTHOR_NO
                INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO
        <where>
            <if test="opt != null">
                <choose>
                    <when test="opt == 'productName'">
                        B.BOOK_NAME like '%' || #{keyword} || '%'
                    </when>
                    <when test="opt == 'author'">
                        A.AUTHOR_NAME = #{keyword}
                    </when>
                    <when test="opt == 'publisher'">
                        P.PUBLISHER_NAME = #{keyword}
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <select id="getBooks" resultType="com.example.bookhub.admin.dto.BookList">
    		SELECT
                    BOOK_NO                         AS no,
    		        BOOK_IMAGE_COVER			    AS image,
    				BOOK_NAME           			AS bookName,
    				AUTHOR_NAME			            AS authorName,
                    BOOK_LIST_PRICE			        AS listPrice,
                    BOOK_SELLING_PRICE			    AS sellingPrice,
                    BOOK_STOCK                      AS stock,
                    BOOK_STATUS                     AS status,
                    BOOK_CREATED_DATE               AS createdDate,
                    BOOK_UPDATED_DATE               AS updatedDate,
                    BOOK_PUBLISHED_DATE             AS publishedDate

    		FROM	(SELECT
                            B.BOOK_NO,
                            BI.BOOK_IMAGE_COVER,
           			        B.BOOK_NAME,
           				    A.AUTHOR_NAME,
                            B.BOOK_LIST_PRICE,
                            ROUND(B.BOOK_LIST_PRICE * (1 - B.BOOK_DISCOUNT_RATE)) AS BOOK_SELLING_PRICE,
                            B.BOOK_STOCK,
    		                B.BOOK_STATUS,
    		                B.BOOK_CREATED_DATE,
    		                B.BOOK_UPDATED_DATE,
    		                B.BOOK_PUBLISHED_DATE,
    						<choose>
    							<when test="sort == 'productName'">
    								row_number() OVER(ORDER BY BOOK_NAME ASC) AS row_num
    							</when>
    							<when test="sort == 'highPrice'">
    								row_number() OVER(ORDER BY BOOK_LIST_PRICE DESC) AS row_num
    							</when>
    							<when test="sort == 'lowPrice'">
    								row_number() OVER(ORDER BY BOOK_LIST_PRICE ASC) AS row_num
    							</when>
    		                    <when test="sort == 'highSellingPrice'">
    								row_number() OVER(ORDER BY BOOK_SELLING_PRICE DESC) AS row_num
    							</when>
								<when test="sort == 'lowSellingPrice'">
    								row_number() OVER(ORDER BY BOOK_SELLING_PRICE ASC) AS row_num
    							</when>
								<when test="sort == 'highStock'">
    								row_number() OVER(ORDER BY BOOK_STOCK DESC) AS row_num
    							</when>
								<when test="sort == 'lowStock'">
    								row_number() OVER(ORDER BY BOOK_STOCK ASC) AS row_num
    							</when>
								<when test="sort == 'recentlyCreated'">
    								row_number() OVER(ORDER BY BOOK_CREATED_DATE DESC) AS row_num
    							</when>
                                <when test="sort == 'recentlyUpdated'">
    								row_number() OVER(ORDER BY BOOK_UPDATED_DATE DESC) AS row_num
    							</when>
                                <when test="sort == 'recentlyPublished'">
    								row_number() OVER(ORDER BY BOOK_PUBLISHED_DATE DESC) AS row_num
    							</when>
    						</choose>

    				FROM
							BookHub.BOOK B
                            INNER JOIN BOOK_AUTHOR BA ON B.BOOK_NO = BA.BOOK_NO
                            INNER JOIN AUTHOR A ON BA.AUTHOR_NO = A.AUTHOR_NO
                            INNER JOIN PUBLISHER P ON B.PUBLISHER_NO = P.PUBLISHER_NO
                            INNER JOIN BOOK_IMAGES BI ON B.BOOK_NO = BI.BOOK_NO

                    <where>
                        <if test="opt != null">
                            <choose>
                                <when test="opt == 'productName'">
                                    B.BOOK_NAME like '%' || #{keyword} || '%'
                                </when>
                                <when test="opt == 'author'">
                                    A.AUTHOR_NAME = #{keyword}
                                </when>
                                <when test="opt == 'publisher'">
                                    P.PUBLISHER_NAME = #{keyword}
                                </when>
                            </choose>
                        </if>
                    </where>
    				) AS subQuery

            LIMIT #{limit} OFFSET #{offset}
    	</select>

        <select id="getPublishers" resultType="com.example.bookhub.product.vo.Publisher">
                SELECT
                    PUBLISHER_NO AS no,
                    PUBLISHER_NAME AS name
                FROM
                    BookHub.PUBLISHER
        </select>
</mapper>
