<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.bookhub.product.mapper.BuyMapper">

    <resultMap id="CouponListResultMap" type="com.example.bookhub.product.vo.CouponProduced">
        <id column="coupon_produced_no" property="couponProducedNo"/>
        <result column="due_date" property="dueDate"/>
        <association column="coupon_no" property="coupon"
                     select="com.example.bookhub.product.mapper.BuyMapper.getCouponByNo"/>
    </resultMap>

    <resultMap id="CouponResultMap" type="com.example.bookhub.product.vo.Coupon">
        <id column="coupon_no" property="couponNo"/>
        <result column="coupon_name" property="name"/>
        <result column="coupon_price" property="price"/>
    </resultMap>

    <!-- association -->
    <select id="getCouponByNo" parameterType="long" resultMap="CouponResultMap">
        select
            coupon_no,
            coupon_name,
            coupon_price
        from
            COUPON
        where
            coupon_no = #{value}
    </select>

    <select id="getCouponsByUserNo" parameterType="long" resultMap="CouponListResultMap">
        select
            coupon_produced_no,
            due_date,
            coupon_no
        from
             COUPON_PRODUCED
        where
             user_no = #{value}
             and due_date >= sysdate()
             and used = 'N'
    </select>

    <select id="getPointByUserNo" parameterType="long" resultType="int">
        select
            user_point
        from
             USER
        where
            user_no = #{value}
    </select>

    <insert id="createBuy" parameterType="com.example.bookhub.product.vo.Buy" >
        insert into BUY
        (total_price, total_book_discount_price, total_coupon_discount_amount, total_point_use_amount, final_price, point_accumulation_amount,
         common_entrance_approach, common_entrance_password, buy_pay_method_no, buy_status_no, buy_delivery_request_no, user_no, delivery_no)
        values
        (#{totalPrice}, #{totalBookDiscountPrice}, #{totalCouponDiscountAmount}, #{totalPointUseAmount}, #{finalPrice}, 1000,
         "...", "1234", 1, 1, 1, #{user.no}, 1)

         <selectKey keyProperty="buyNo" resultType="long" order="AFTER">
             select last_insert_id()
         </selectKey>
    </insert>

    <insert id="createBuyBook" parameterType="com.example.bookhub.product.vo.BuyBook">
        insert into BUY_BOOK
        (buy_no, book_no, count)
        values
        (#{buyNo}, #{bookNo}, #{count})
    </insert>

</mapper>