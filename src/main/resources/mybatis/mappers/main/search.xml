<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.bookhub.main.mapper.SearchMapper">

    <select id="searchBooks" parameterType="com.example.bookhub.main.dto.SearchCriteria" resultMap="bookResultMap">
        SELECT BOOK_NAME, BOOK_PUBLISHED_DATE, BOOK_DESCRIPTION, ISBN, BOOK_LIST_PRICE
        FROM BOOK
        WHERE
            <!--navbar 검색-->
        <choose>
            <when test="opt == '국내'">
                CATEGORY_NO IN (SELECT CATEGORY_NO FROM CATEGORY WHERE PARENT_CATEGORY_NO = 1)
                AND BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="opt == '국외'">
                CATEGORY_NO IN (SELECT CATEGORY_NO FROM CATEGORY WHERE PARENT_CATEGORY_NO = 2)
                AND BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <otherwise>
                BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </otherwise>
        </choose>
        <!--결과내 검색 -->
        <if test="extraKeyword != null">
            AND BOOK_NAME LIKE CONCAT('%', #{extraKeyword}, '%')
        </if>
        <!-- 검색 정렬 -->
        <choose>
            <when test="sort == '판매량순'">
                ORDER BY BOOK_SALES_VOLUME
            </when>
            <when test="sort == '출시일순'">
                ORDER BY BOOK_PUBLISHED_DATE
            </when>
            <when test="sort == '평점순'">
                ORDER BY BOOK_AVARAGE_RATING
            </when>
            <when test="sort == '리뷰순'">
                ORDER BY BOOK_TOTAL_REPLY_COUNT
            </when>
        </choose>
        <!-- 페이징 처리 -->
        <if test="pageNumber != null and pageSize != null">
            LIMIT #{pageNumber * pageSize}, #{pageSize}
        </if>
    </select>

    <!--조회 결과 집합을 객체로 매핑-->
    <resultMap id="bookResultMap" type="com.example.bookhub.main.vo.Book">
        <result column="BOOK_NAME" property="bookName"/>
        <result column="BOOK_PUBLISHED_DATE" property="bookPublishedDate"/>
        <result column="BOOK_DESCRIPTION" property="bookDescription"/>
        <result column="ISBN" property="isbn"/>
        <result column="BOOK_LIST_PRICE" property="bookListPrice"/>
    </resultMap>


    <!--페이징처리를 위해 검색결과 개수 -->
    <select id="booksGetTotal" parameterType="com.example.bookhub.main.dto.SearchCriteria" resultType="int" >
        SELECT COUNT(*)
        FROM BOOK
        WHERE
        <choose>
            <when test="opt == '국내'">
                CATEGORY_NO IN (SELECT CATEGORY_NO FROM CATEGORY WHERE PARENT_CATEGORY_NO = 1)
                AND BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="opt == '국외'">
                CATEGORY_NO IN (SELECT CATEGORY_NO FROM CATEGORY WHERE PARENT_CATEGORY_NO = 2)
                AND BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <otherwise>
                BOOK_NAME LIKE CONCAT('%', #{keyword}, '%')
            </otherwise>
        </choose>

        <if test="extraKeyword != null">
            AND BOOK_NAME LIKE CONCAT('%', #{extraKeyword}, '%')
        </if>
    </select>


</mapper>